name: Auto-Create Feature PR

on:
  issues:
    types: [opened, reopened]

permissions:
  issues: write
  contents: write
  pull-requests: write

jobs:
  create-feature-pr:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate Feature File and Create PR
        uses: actions/github-script@v7
        env:
          MODELS_TOKEN: ${{ secrets.MODELS_TOKEN }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueBody = context.payload.issue.body || '';
            const issueTitle = context.payload.issue.title || '';
            const issueNumber = context.payload.issue.number;
            const issueLabels = context.payload.issue.labels.map(l => l.name).join(', ');
            
            // Create branch name from issue
            const branchName = 'feature/issue-' + issueNumber + '-' + issueTitle.toLowerCase().replace(/[^a-z0-9]+/g, '-').substring(0, 50);
            
            // Create feature file name
            const featureFileName = issueTitle.toLowerCase().replace(/[^a-z0-9]+/g, '-').substring(0, 50);
            const featureFilePath = 'specs/' + featureFileName + '/' + featureFileName + '.feature';
            
            console.log('Creating branch: ' + branchName);
            console.log('Feature file: ' + featureFilePath);
            
            // Read the kickoff-feature and create-test-plan prompts
            const fs = require('fs');
            
            let kickoffPrompt, createTestPlanPrompt;
            try {
              kickoffPrompt = fs.readFileSync('.github/prompts/kickoff-feature.prompt.md', 'utf8');
              createTestPlanPrompt = fs.readFileSync('.github/prompts/create-test-plan.prompt.md', 'utf8');
            } catch (error) {
              console.log('Could not read prompt files, using inline prompts');
            }
            
            // Construct the system prompt for Copilot
            const systemPrompt = 'You are an expert BDD test plan generator following the kickoff-feature workflow.\n\n' +
              (kickoffPrompt || '') + '\n\n' +
              'METHODOLOGY (from create-test-plan):\n' +
              (createTestPlanPrompt || '') + '\n\n' +
              'Generate comprehensive Gherkin scenarios following these principles:\n\n' +
              '1. **Declarative Style**: Focus on behavior, not implementation\n' +
              '2. **Three Amigos Perspective**: Product, Developer, and Tester perspectives\n' +
              '3. **Structure**: Use proper Gherkin format with Feature, Background, Scenarios\n' +
              '4. **Coverage**: Include happy paths, edge cases, error handling, data validation\n' +
              '5. **Anti-Fragility**: Tests serve as living documentation, stable across refactors\n\n' +
              'Output ONLY the Gherkin feature file content, no markdown formatting or explanations.';
            
            const userPrompt = 'Generate a comprehensive BDD test plan for this issue:\n\n' +
              '**Title**: ' + issueTitle + '\n' +
              '**Labels**: ' + (issueLabels || 'None') + '\n\n' +
              '**Description**:\n' + issueBody + '\n\n' +
              'Create detailed Gherkin scenarios with Feature description, Background (if needed), and multiple Scenarios covering happy paths, edge cases, and error conditions.\n\n' +
              'Output ONLY the Gherkin content starting with "Feature:", no markdown code blocks.';
            
            try {
              // Call GitHub Models API (Copilot-powered)
              const modelsToken = process.env.MODELS_TOKEN || process.env.GITHUB_TOKEN;

              if (!modelsToken) {
                throw new Error('Missing token. Set MODELS_TOKEN secret.');
              }

              const response = await fetch('https://models.inference.ai.azure.com/chat/completions', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': 'Bearer ' + modelsToken
                },
                body: JSON.stringify({
                  messages: [
                    { role: 'system', content: systemPrompt },
                    { role: 'user', content: userPrompt }
                  ],
                  model: 'gpt-4o',
                  temperature: 0.7,
                  max_tokens: 4000
                })
              });
              
              if (!response.ok) {
                const errorText = await response.text();
                throw new Error('API call failed: ' + response.status + ' ' + response.statusText + '\n' + errorText);
              }
              
              const data = await response.json();
              let generatedContent = data.choices[0].message.content;
              
              // Clean up content - remove markdown code blocks if present
              generatedContent = generatedContent.replace(/```gherkin\n?/g, '').replace(/```\n?$/g, '').trim();
              
              console.log('‚úÖ Generated feature content');
              
              // Get default branch
              const { data: repo } = await github.rest.repos.get({
                owner: context.repo.owner,
                repo: context.repo.repo
              });
              const defaultBranch = repo.default_branch;
              
              // Get the SHA of the default branch
              const { data: refData } = await github.rest.git.getRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: 'heads/' + defaultBranch
              });
              const baseSha = refData.object.sha;
              
              // Create new branch
              await github.rest.git.createRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: 'refs/heads/' + branchName,
                sha: baseSha
              });
              
              console.log('‚úÖ Created branch');
              
              // Create the feature file
              const featureContent = Buffer.from(generatedContent).toString('base64');
              
              await github.rest.repos.createOrUpdateFileContents({
                owner: context.repo.owner,
                repo: context.repo.repo,
                path: featureFilePath,
                message: 'Add feature file for issue #' + issueNumber + ': ' + issueTitle,
                content: featureContent,
                branch: branchName
              });
              
              console.log('‚úÖ Created feature file');
              
              // Create step definitions stub file
              const stepDefsDir = 'specs/' + featureFileName + '/step_definitions';
              const stepDefsFile = stepDefsDir + '/' + featureFileName + '_steps.rb';
              
              const stepDefsContent = '# Step definitions for ' + issueTitle + '\n' +
                '# Generated from issue #' + issueNumber + '\n\n' +
                '# Implement your step definitions here\n' +
                '# Example:\n' +
                '# Given(\'initial state\') do\n' +
                '#   # Setup code\n' +
                '# end\n' +
                '#\n' +
                '# When(\'action is performed\') do\n' +
                '#   # Action code\n' +
                '# end\n' +
                '#\n' +
                '# Then(\'expected outcome occurs\') do\n' +
                '#   # Assertion code\n' +
                '# end\n';
              
              await github.rest.repos.createOrUpdateFileContents({
                owner: context.repo.owner,
                repo: context.repo.repo,
                path: stepDefsFile,
                message: 'Add step definitions stub for issue #' + issueNumber,
                content: Buffer.from(stepDefsContent).toString('base64'),
                branch: branchName
              });
              
              console.log('‚úÖ Created step definitions stub');
              
              // Create Pull Request
              const prBody = '## ü§ñ Auto-generated Feature from Issue #' + issueNumber + '\n\n' +
                '**Issue**: #' + issueNumber + '\n' +
                '**Feature File**: `' + featureFilePath + '`\n' +
                '**Step Definitions**: `' + stepDefsFile + '`\n\n' +
                '### Generated BDD Test Plan\n\n' +
                'This PR contains:\n' +
                '- ‚úÖ Gherkin feature file with comprehensive scenarios\n' +
                '- ‚úÖ Step definitions stub file (needs implementation)\n\n' +
                '### Test Plan Preview\n\n' +
                '```gherkin\n' +
                generatedContent.split('\n').slice(0, 30).join('\n') + '\n' +
                (generatedContent.split('\n').length > 30 ? '...\n' : '') +
                '```\n\n' +
                '### Next Steps\n\n' +
                '1. **Review the scenarios** in [`' + featureFilePath + '`](../blob/' + branchName + '/' + featureFilePath + ')\n' +
                '2. **Implement step definitions** in [`' + stepDefsFile + '`](../blob/' + branchName + '/' + stepDefsFile + ')\n' +
                '3. **Run tests**: `cucumber ' + featureFilePath + '`\n' +
                '4. **Refine as needed** based on feedback\n\n' +
                '### Three Amigos Review\n\n' +
                '- [ ] **Product**: Scenarios match business requirements\n' +
                '- [ ] **Developer**: Scenarios are implementable\n' +
                '- [ ] **QA**: Coverage includes happy paths and edge cases\n\n' +
                '---\n\n' +
                '*Auto-generated using [`/kickoff-feature`](.github/prompts/kickoff-feature.prompt.md) prompt*\n' +
                '*Closes #' + issueNumber + ' once merged*';

              const { data: pr } = await github.rest.pulls.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'Feature: ' + issueTitle,
                head: branchName,
                base: defaultBranch,
                body: prBody
              });
              
              console.log('‚úÖ Created pull request');
              
              // Assign the PR to Copilot (if possible) or link to issue
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                labels: ['auto-generated', 'bdd-test-plan']
              });
              
              // Comment on the original issue with PR link
              const issueComment = '## ü§ñ Feature Automation Complete\n\n' +
                '‚úÖ **Pull Request Created**: #' + pr.number + '\n' +
                '‚úÖ **Branch**: `' + branchName + '`\n' +
                '‚úÖ **Feature File**: `' + featureFilePath + '`\n\n' +
                '### What was created:\n' +
                '- Comprehensive Gherkin feature file with scenarios\n' +
                '- Step definitions stub file for implementation\n' +
                '- Pull request ready for review\n\n' +
                'üëâ **Review the PR here**: #' + pr.number + '\n\n' +
                '---\n\n' +
                '*Generated using [`/kickoff-feature`](.github/prompts/kickoff-feature.prompt.md) automation*';
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: issueComment
              });
              
              console.log('‚úÖ All automation steps completed successfully');
              
            } catch (error) {
              console.error('‚ùå Error in automation:', error);
              
              // Post error comment to issue
              const errorComment = '## ‚ö†Ô∏è Automated Feature PR Creation Failed\n\n' +
                'Unable to automatically create the feature file and pull request.\n\n' +
                '**Error**: ' + error.message + '\n\n' +
                '### Manual Steps:\n' +
                '1. Use [`@copilot /kickoff-feature`](.github/prompts/kickoff-feature.prompt.md) to generate test plan\n' +
                '2. Create feature file in `specs/` directory\n' +
                '3. Implement step definitions\n' +
                '4. Create pull request manually\n\n' +
                '---\n\n' +
                '*Error occurred during automation. Please proceed manually.*';
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: errorComment
              });
              
              throw error;
            }
