name: Generate BDD Test Plan for Issue

on:
  issues:
    types: [opened, reopened]

jobs:
  generate-test-plan:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
      models: read
    
    steps:
      - name: Generate AI-Powered BDD Test Plan
        uses: actions/github-script@v7
        env:
          GITHUB_MODELS_TOKEN: ${{ secrets.GITHUB_MODELS_TOKEN }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue = context.payload.issue;
            const issueTitle = issue.title;
            const issueBody = issue.body || 'No description provided';
            const issueLabels = issue.labels.map(l => l.name).join(', ');
            
            // System prompt for BDD test plan generation
            const systemPrompt = `You are an expert BDD test plan generator following Specification by Example principles.
            
            Generate comprehensive Gherkin scenarios based on the issue description. Follow these guidelines:
            
            1. **Declarative Style**: Focus on behavior, not implementation
               - ‚ùå "When I click the calculate button"
               - ‚úÖ "When the system calculates regression on valid data"
            
            2. **Three Amigos Perspective**:
               - Product: Business rules and happy paths
               - Developer: Technical boundaries and state requirements
               - Tester: Edge cases, race conditions, failure modes
            
            3. **Structure**: Use proper Gherkin format:
               - Feature description with business value
               - Background (if applicable)
               - Scenarios with Given-When-Then
               - Scenario Outlines only when necessary
            
            4. **Coverage**: Include:
               - Happy path scenarios
               - Edge cases and error handling
               - Data validation scenarios
               - API/integration scenarios (if applicable)
            
            5. **Format**: Wrap scenarios in a markdown code block with \`\`\`gherkin
            
            6. **Anti-Fragility**: Ensure tests serve as living documentation and remain stable across refactors.`;
            
            const userPrompt = `Generate a BDD test plan for this GitHub issue:
            
            **Title**: ${issueTitle}
            **Labels**: ${issueLabels || 'None'}
            **Description**:
            ${issueBody}
            
            Create Gherkin scenarios that comprehensively cover this feature/bug/enhancement.`;
            
            try {
              // Call GitHub Models API (Copilot-powered)
              const modelsToken = process.env.GITHUB_MODELS_TOKEN || process.env.GITHUB_TOKEN;

              if (!modelsToken) {
                throw new Error('Missing GitHub Models token. Set GITHUB_MODELS_TOKEN secret or enable GITHUB_TOKEN with models: read.');
              }

              const response = await fetch('https://models.inference.ai.azure.com/chat/completions', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${modelsToken}`
                },
                body: JSON.stringify({
                  model: 'gpt-4o',
                  messages: [
                    { role: 'system', content: systemPrompt },
                    { role: 'user', content: userPrompt }
                  ],
                  temperature: 0.7,
                  max_tokens: 2000
                })
              });
              
              if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`OpenAI API error: ${response.status} - ${errorText}`);
              }
              
              const data = await response.json();
              const testPlan = data.choices[0].message.content;
              
              // Create formatted comment
              const comment = [
                '## üß™ BDD Test Plan Generated (AI-Powered by GitHub Copilot)',
                '',
                testPlan,
                '',
                '---',
                '',
                '<details>',
                '<summary>üìã Test Plan Guidelines</summary>',
                '',
                '### Running These Tests',
                '',
                '```bash',
                '# Create feature file',
                'mkdir -p specs/[feature-name]',
                '# Add scenarios to specs/[feature-name]/[feature-name].feature',
                '',
                '# Implement step definitions',
                '# Create specs/[feature-name]/step_definitions/[feature]_steps.rb',
                '',
                '# Run tests',
                'bundle exec cucumber specs/[feature-name]/',
                '```',
                '',
                '### Test Philosophy',
                '- **Declarative**: Focus on behavior, not implementation',
                '- **Three Amigos**: Cover Product, Developer, and Tester perspectives',
                '- **Living Documentation**: Tests serve as executable specifications',
                '- **Anti-Fragile**: Stable across refactors and implementation changes',
                '',
                '### Reference',
                'See [BDD_TEST_PLAN.md](../blob/main/BDD_TEST_PLAN.md) for complete guidelines.',
                '</details>',
                '',
                '*Generated using GitHub Copilot (GPT-4o) based on Specification by Example principles*'
              ].join('\n');
              
              // Post comment to issue
              await github.rest.issues.createComment({
                issue_number: issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
              
              console.log('‚úÖ Test plan generated and posted successfully');
              
            } catch (error) {
              console.error('Error generating test plan:', error);
              
              // Fallback: Post error message with manual template
              const fallbackComment = [
                '## ‚ö†Ô∏è Test Plan Generation Failed',
                '',
                `Unable to generate AI-powered test plan. Error: ${error.message}`,
                '',
                '### Manual BDD Test Plan Template',
                '',
                'Please create test scenarios following this structure:',
                '',
                '```gherkin',
                'Feature: [Feature Name]',
                '  As a [role]',
                '  I want to [action]',
                '  So that [business value]',
                '',
                '  Background:',
                '    Given [common precondition]',
                '    And [another precondition]',
                '',
                '  Scenario: [Happy path scenario name]',
                '    Given [initial context]',
                '    When [action occurs]',
                '    Then [expected outcome]',
                '    And [additional verification]',
                '',
                '  Scenario: [Edge case scenario name]',
                '    Given [edge case context]',
                '    When [action with edge case]',
                '    Then [expected error handling]',
                '',
                '  Scenario: [Error handling scenario name]',
                '    Given [error condition]',
                '    When [action attempted]',
                '    Then [graceful failure behavior]',
                '```',
                '',
                '### Guidelines',
                '- Use **declarative** style (behavior-focused, not implementation-focused)',
                '- Cover **Three Amigos** perspectives: Product, Developer, Tester',
                '- Include happy paths, edge cases, and error scenarios',
                'See [BDD_TEST_PLAN.md](../blob/main/BDD_TEST_PLAN.md) for complete guidelines',
                '',
                '*Please generate test scenarios manually and update this issue*'
              ].join('\n');
              
              await github.rest.issues.createComment({
                issue_number: issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: fallbackComment
              });
            }
