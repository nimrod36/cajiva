#!/bin/bash
# Pre-push hook: Run full test suite before push
# Skip with: SKIP_HOOKS=1 git push

# Check if hooks should be skipped
if [ "$SKIP_HOOKS" = "1" ] || [ "$NO_VERIFY" = "1" ]; then
  echo "âš ï¸  Skipping pre-push checks (SKIP_HOOKS=1)"
  exit 0
fi

echo "ðŸš€ Running pre-push checks..."
echo "(Skip with: SKIP_HOOKS=1 git push or git push --no-verify)"
echo ""

# Run RSpec tests
echo "Running RSpec test suite..."
bundle exec rspec --fail-fast
if [ $? -ne 0 ]; then
  echo "âŒ RSpec tests failed! Push aborted."
  exit 1
fi

# Run Cucumber tests
echo ""
echo "Running Cucumber test suite..."
bundle exec cucumber specs/ --fail-fast
if [ $? -ne 0 ]; then
  echo "âŒ Cucumber tests failed! Push aborted."
  exit 1
fi

# Detect target branch (main/master requires 100% coverage)
TARGET_BRANCH=$(git rev-parse --abbrev-ref HEAD 2>/dev/null)
REMOTE_BRANCH=""
while read local_ref local_sha remote_ref remote_sha; do
  REMOTE_BRANCH=$(echo "$remote_ref" | sed 's#refs/heads/##')
done

# Determine coverage requirement
if [ "$TARGET_BRANCH" = "main" ] || [ "$TARGET_BRANCH" = "master" ] || [ "$REMOTE_BRANCH" = "main" ] || [ "$REMOTE_BRANCH" = "master" ]; then
  REQUIRED_COVERAGE=100
  IS_MAIN_BRANCH=true
  echo "ðŸŽ¯ Pushing to main/master branch - 100% coverage required"
else
  REQUIRED_COVERAGE=80
  IS_MAIN_BRANCH=false
  echo "ðŸ“Š Pushing to feature branch - 80% coverage recommended"
fi

# Run test coverage check
echo ""
echo "Running test coverage analysis..."
bundle exec rspec --format documentation --format json --out tmp/rspec_results.json
if [ $? -ne 0 ]; then
  echo "âŒ Coverage check failed! Push aborted."
  exit 1
fi

# Check SimpleCov coverage (if available)
if [ -f "coverage/.last_run.json" ]; then
  COVERAGE=$(ruby -rjson -e 'puts JSON.parse(File.read("coverage/.last_run.json"))["result"]["line"]' 2>/dev/null)
  if [ ! -z "$COVERAGE" ]; then
    COVERAGE_INT=$(echo "$COVERAGE" | cut -d. -f1)
    echo "ðŸ“Š Test coverage: ${COVERAGE}%"
    
    if [ "$COVERAGE_INT" -lt "$REQUIRED_COVERAGE" ]; then
      if [ "$IS_MAIN_BRANCH" = true ]; then
        echo "âŒ Coverage requirement not met for main/master!"
        echo "   Required: ${REQUIRED_COVERAGE}%, Current: ${COVERAGE}%"
        echo "   All code merged to main/master must have 100% test coverage."
        exit 1
      else
        echo "âš ï¸  Warning: Coverage is below ${REQUIRED_COVERAGE}% (currently ${COVERAGE}%)"
        echo "   Consider adding more tests before pushing."
      fi
    else
      echo "âœ… Coverage requirement met (${COVERAGE}% >= ${REQUIRED_COVERAGE}%)"
    fi
  fi
fi

echo ""
echo "âœ… All tests passed! Ready to push."
exit 0
